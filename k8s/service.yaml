apiVersion: v1
kind: Service
metadata:
  name: authify
  namespace: authify
  labels:
    app: authify
spec:
  # Headless service (ClusterIP: None) required for libcluster DNS discovery
  # Prometheus scrapes pods directly, not through this service
  clusterIP: None
  publishNotReadyAddresses: true  # Important for clustering before pods are ready
  ports:
    - port: 4000
      targetPort: 4000
      protocol: TCP
      name: http
    - port: 4369
      targetPort: 4369
      protocol: TCP
      name: epmd  # Erlang Port Mapper Daemon for clustering
  selector:
    app: authify
---
# Regular service for external access (via Ingress)
# Note: Metrics are NOT exposed here - Prometheus scrapes pods directly
apiVersion: v1
kind: Service
metadata:
  name: authify-external
  namespace: authify
  labels:
    app: authify
spec:
  type: ClusterIP
  ports:
    - port: 80
      targetPort: 4000
      protocol: TCP
      name: http
  selector:
    app: authify
